# 乳児うつ伏せ検知デバイス 要件定義

## 1. 背景と目的

- Freenove ESP32-S3 WROOM CAM で乳児のうつ伏せ状態を検知する。
- 同一デバイス上で映像配信と推論を行い、ブラウザで状況を即時確認できるようにする。
- うつ伏せ検知時は対象領域を赤い四角で囲み、視認性を最優先にする。

## 2. スコープ

- 対象:
  - ハードウェア: Freenove ESP32-S3 WROOM CAM
  - 開発環境: VS Code + ESP-IDF
  - 推論基盤: ESP-DL
  - 通信方式: Wi-Fi STA
  - 表示方式: HTTP サーバのブラウザ表示
- 非対象:
  - モバイルアプリ通知
  - クラウド推論
  - 医療用途認証

## 3. 前提条件

- Wi-Fi 認証情報はソースコードへハードコードする。
- カメラは 2.4GHz Wi-Fi が安定して届く位置に固定する。
- 乳児全身が画角に入る向きで設置する。
- 現時点の実装は未着手であり、本書は初期実装要件を定義する。

## 4. 機能要件

1. Wi-Fi 接続
   - デバイス起動時に STA モードで既存アクセスポイントへ接続する。
   - SSID とパスワードは `main.c` 内の定数で固定する。

2. カメラ映像配信
   - HTTP サーバを起動し、ブラウザアクセスでライブ映像を表示する。
   - 画像配信は MJPEG ストリームを基本方式とする。

3. うつ伏せ検知
   - 各フレームで「うつ伏せ」「非うつ伏せ」を推論する。
   - 連続検知時間がしきい値を超えた場合に警告状態へ遷移する。

4. 赤枠オーバーレイ
   - 警告状態のフレームでは、検知領域へ赤色矩形を描画する。
   - 非警告時は赤枠を表示しない。

5. 状態監視
   - 起動、接続、推論、警告、障害を状態として管理する。
   - 障害発生時は HTTP 応答から状態を判別できる情報を返す。

## 5. 既定動作

- 電源投入後に Wi-Fi 接続を開始する。
- Wi-Fi 接続後に HTTP サーバを起動する。
- HTTP クライアントが未接続でも推論処理は継続する。
- 検知状態はフレーム単位ではなく連続時間で判定する。

## 6. 数値要件と境界値

- フレームサイズ: 320x240（固定）
- JPEG 品質: 12（範囲 10 〜 63、既定 12）
- 推論周期: 500ms（範囲 200 〜 1000ms）
- うつ伏せ確定時間: 10秒（範囲 3 〜 30秒）
- 検知信頼度しきい値: 0.70（範囲 0.50 〜 0.95）
- Wi-Fi 再接続試行間隔: 5秒（範囲 2 〜 30秒）
- HTTP 応答タイムアウト: 5秒（範囲 2 〜 10秒）

## 7. エラー時の挙動

1. Wi-Fi 接続失敗
   - 5秒間隔で再接続を繰り返す。
   - HTTP サーバが未起動の場合は起動を保留する。

2. カメラ初期化失敗
   - ストリーム配信を開始しない。
   - 状態を `FAULT_CAMERA` にしてログ出力する。

3. ESP-DL 推論失敗
   - 当該フレームを `UNKNOWN` として扱う。
   - 連続失敗 10 回で状態を `FAULT_INFERENCE` に遷移させる。

4. オーバーレイ描画失敗
   - 該当フレームは描画なしで送出する。
   - 失敗回数をログで記録し、推論は停止しない。

## 8. 受け入れ条件

- AC-001: 電源投入後 30 秒以内に Wi-Fi 接続が完了する。
- AC-002: ブラウザで `/` アクセス時にライブ映像を表示できる。
- AC-003: うつ伏せ継続 10 秒を再現した場合、赤枠付き映像へ遷移する。
- AC-004: 非うつ伏せ映像を 10 分入力したとき、赤枠表示誤検知が 1 回以下である。
- AC-005: Wi-Fi 切断後に復帰させたとき、60 秒以内に配信を自動再開する。

## 9. 制約

- SSID とパスワードはハードコードで運用する。
- HTTPS 化や認証は初期スコープ外とする。
- 本デバイスは補助監視用途であり、人的監視を代替しない。

## 10. 採用理由の深掘り

1. なぜローカル推論か
   - 回線遅延に依存せず、映像と判定の同期を維持するため。
2. なぜブラウザ表示か
   - 専用アプリなしで確認でき、導入と検証の手間を最小化するため。
3. なぜ赤枠表示か
   - 文字通知よりも注視点が明確で、判断時間を短縮できるため。
